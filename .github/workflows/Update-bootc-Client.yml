name: Update Bootc Client

on:
  workflow_dispatch:

env:
  IMAGE_NAME: my_dashboard
  HARBOR_REGISTRY: harbor.bootc.com:80

jobs:
  update:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      # 1. 버전 생성
      - name: Set Version
        id: version
        run: |
          if [ -n "${{ github.sha }}" ]; then
            echo "VERSION=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          else
            echo "VERSION=manual-${{ github.run_id }}" >> $GITHUB_ENV
          fi

      # 2. 이미지 빌드
      - name: Build Image
        run: |
          podman build -f Containerfile_Update \
            -t $HARBOR_REGISTRY/smarthome/$IMAGE_NAME:$VERSION .

      # 3. Harbor 푸시
      - name: Push to Harbor
        run: |
          podman login -u ${{ secrets.HARBOR_USER }} -p ${{ secrets.HARBOR_PASSWORD }} $HARBOR_REGISTRY
          podman push $HARBOR_REGISTRY/smarthome/$IMAGE_NAME:$VERSION
          podman tag $HARBOR_REGISTRY/smarthome/$IMAGE_NAME:$VERSION $HARBOR_REGISTRY/smarthome/$IMAGE_NAME:latest
          podman push $HARBOR_REGISTRY/smarthome/$IMAGE_NAME:latest
